# sodacan.yaml
# ---
# This is your master configuration file for the hackathon demo.
# Secrets (like passwords) are loaded from environment variables (e.g., ${VAR_NAME})
# for security.

# AI Configuration
ai:
  # This is the model that powers the 'soda build' translator and 'soda watch' enricher
  model: "gemini-2.5-flash"

# Default settings
source_defaults:
  csv_encoding: utf-8

# ---
# Source definitions (for the `soda build` -> `connect to` command)
# ---
sources:
  # Source for Flow 2: The "complex" internal database
  gcp_legacy_db:
    type: "mysql"
    host: "35.196.136.21"
    port: 3306
    database: "soda_hackathon_db"
    user: "manraaj"
    password: "Dartmouth1234("
    
    # This query will be run by `soda` to get the starting data
    # It pulls the messy, PII-filled data
    query: "SELECT * FROM RAW_TRANSACTIONS;"

  # Source for Flow 3: The "complex" internal analytics query
  snowflake_prod:
    type: "snowflake"
    # Set these as environment variables on your VM
    account: "${SNOWFLAKE_ACCOUNT}" 
    user: "${SNOWFLAKE_USER}"
    password: "${SNOWFLAKE_PASSWORD}"
    role: "SYSADMIN"
    warehouse: "SODA_WH"
    database: "HACKATHON_DB"
    schema: "PUBLIC"
    # This is the complex query `soda` runs to get the internal numbers
    query: |
      SELECT
          'Fictional Tech Inc.' AS Company,
          p.Business_Segment,
          CASE 
              WHEN MONTH(t.Sale_Timestamp) IN (4,5,6) THEN 'Q2-2025'
              WHEN MONTH(t.Sale_Timestamp) IN (7,8,9) THEN 'Q3-2025'
          END AS Quarter,
          SUM(t.Sale_Amount) / 1000000 AS Revenue_Millions,
          'N/A' AS Commentary
      FROM INTERNAL_TRANSACTIONS t
      JOIN PRODUCT_SEGMENTS p ON t.Product_SKU = p.Product_SKU
      GROUP BY 1, 2, 3
      ORDER BY 3, 2;

# ---
# Sink definitions (for the `save to` and `soda watch` commands)
# ---
sinks:
  # Sink for Flow 1: The live-feed demo
  google_sheet_live:
    type: googlesheets
    spreadsheet_id: "YOUR_SODA_LIVE_FEED_SHEET_ID_HERE"
    worksheet_name: "Sheet1"
    credentials_path: "/home/manraaj06s/.sodacan-creds/gcp-service-key.json"

  # Sink for Flow 3: The Tableau feed
  google_sheet_bi:
    type: googlesheets
    spreadsheet_id: "YOUR_TABLEAU_FEED_SHEET_ID_HERE"
    worksheet_name: "Sheet1"
    credentials_path: "/home/manraaj06s/.sodacan-creds/gcp-service-key.json"

  # Sink for Flow 2: The "data lake" for engineers
  gcs_datalake:
    type: gcs_parquet
    bucket_name: "sodacan-datalake"
    blob_path: "clean_data/raw_transactions_clean.parquet"
    credentials_path: "/home/manraaj06s/.sodacan-creds/gcp-service-key.json"

  # Sink for Flow 3: The direct-to-warehouse write
  snowflake_prod:
    type: snowflake
    auto_connect: true # This will enable the direct-write
    account: "${SNOWFLAKE_ACCOUNT}"
    user: "${SNOWFLAKE_USER}"
    password: "${SNOWFLAKE_PASSWORD}"
    role: "SYSADMIN" # Needs permission to CREATE/TRUNCATE tables
    warehouse: "SODA_WH"
    database: "HACKATHON_DB"
    schema: "PUBLIC"
    # table_name will be provided by the command (e.g., 'QBR_FINAL_DATA')
  
  # A simple sink for testing (based on your file)
  excel:
    type: excel
    output_dir: ./client_exports/

# ---
# AI Task definitions (for Gemini API)
# ---
tasks:
  # Task for Flow 1: `soda watch`
  categorize_transaction:
    prompt_template: |
      You are a finance expert. Categorize this transaction: {row_dict}
      Use one of these categories: 'Office Supplies', 'Software', 'Travel', 'Food', 'Other'.
      Provide only the category name.
    output_field: "category"

  # Task for Flow 3: The `merge_10Q` command
  merge_10Q:
    prompt_template: |
      You are an expert financial analyst. I am providing you with a quarterly 10-Q report. 
      Your task is to extract two types of information and return a clean JSON array.
      
      1.  **Structured Data:** Find the 'Revenues' table disaggregated by segment (e.g., 'Google Services', 'Google Cloud').
      2.  **Unstructured Data:** Go to the 'Management's Discussion and Analysis' (MD&A) section. For each business segment, find the *single key sentence* that *explains the reason* for its revenue performance (growth or decline).

      **Output Format:**
      Return a JSON array. For each segment, create an object with these exact fields:
      * `Company`: "{company}"
      * `Business_Segment`: The segment name (e.g., "Google Cloud")
      * `Quarter`: "{quarter}"
      * `Revenue_Millions`: The revenue for that segment (in millions).
      * `Commentary`: The key sentence you extracted from the MD&A about that segment.
      
      Only return the JSON array.
    output_type: "json"